unit sangria;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ExtCtrls, StdCtrls, Mask, RzEdit, Menus, AdvMenus, ComCtrls,
  XPMan, AdvGlowButton, AdvMetroButton, AdvSmoothPanel, AdvSmoothExpanderPanel,
  principal, frxClass, frxDBSet, frxDesgn, System.Actions, Vcl.ActnList,
  Vcl.PlatformDefaultStyleActnCtrls, Vcl.ActnMan, Data.DB, ZAbstractRODataset,
  ZAbstractDataset, ZDataset, MemDS, DBAccess, Uni;

type
  TfrmSangria = class(TForm)
    Panel1: TPanel;
    bt_ok1: TButton;
    bt_cancelar1: TButton;
    Panel2: TPanel;
    Label1: TLabel;
    ed_valor: TRzNumericEdit;
    pop_fechamento: TAdvPopupMenu;
    Cancelar1: TMenuItem;
    AdvSmoothExpanderPanel1: TAdvSmoothExpanderPanel;
    Label53: TLabel;
    AdvMetroButton1: TAdvMetroButton;
    bt_ok: TAdvGlowButton;
    bt_cancelar: TAdvGlowButton;
    fxSangria: TfrxReport;
    frxEmitente: TfrxDBDataset;
    frxDesigner1: TfrxDesigner;
    ActionManager1: TActionManager;
    Action1: TAction;
    lbEdicao: TLabel;
    Panel3: TPanel;
    Button1: TButton;
    Button2: TButton;
    Panel4: TPanel;
    Button3: TButton;
    Button4: TButton;
    Edit2: TEdit;
    Label7: TLabel;
    frxobs_sangria: TfrxDBDataset;
    qrobs_sangria: TUniQuery;
    qrsangria: TUniQuery;
    qrobs_sangriaSV: TUniQuery;
    qrsangria_servidor: TUniQuery;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure bt_cancelar1Click(Sender: TObject);
    procedure bt_ok1Click(Sender: TObject);
    procedure Cancelar1Click(Sender: TObject);
    procedure AdvMetroButton1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure fxSangriaBeforePrint(Sender: TfrxReportComponent);
    procedure FormCreate(Sender: TObject);
    procedure Action1Execute(Sender: TObject);
    procedure ed_valorEnter(Sender: TObject);
    procedure Edit2Exit(Sender: TObject);
    procedure ed_valorExit(Sender: TObject);
  private
    { Private declarations }
    TipoImp: TImpressora;
    Editar:Boolean;
  public
    { Public declarations }
  end;

var
  frmSangria: TfrmSangria;

implementation

uses modulo, unECF, funcoes, menu_fiscal, UFuncoes, venda;

{$R *.dfm}

procedure TfrmSangria.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  frmPrincipal.TipoImpressora := TipoImp;
  action := cafree;
end;

procedure TfrmSangria.FormCreate(Sender: TObject);
begin
  Editar := False;
end;

procedure TfrmSangria.FormShow(Sender: TObject);
begin
  TipoImp := frmPrincipal.TipoImpressora;
  frmPrincipal.TipoImpressora := NaoFiscal;
end;

procedure TfrmSangria.fxSangriaBeforePrint(Sender: TfrxReportComponent);
begin
  if Sender is TfrxMemoView then begin
    if TfrxMemoView(Sender).Name = 'mCaixa' then
      TfrxMemoView(Sender).Text := 'Caixa:'+Zerar(IntToStr(iNumCaixa),3);
    if TfrxMemoView(Sender).Name = 'mValor' then
      TfrxMemoView(Sender).Text := FormatFloat('#,##0.00',ed_valor.Value);
    if TfrxMemoView(Sender).Name = 'mOperador' then
      TfrxMemoView(Sender).Text := 'Operador: ' + sNome_Operador;
  end;

end;

procedure TfrmSangria.Action1Execute(Sender: TObject);
begin
  if Editar then
    Editar := False
  else
    Editar := True;
  lbEdicao.Visible := Editar;
end;

procedure TfrmSangria.AdvMetroButton1Click(Sender: TObject);
begin
  close;
end;

procedure TfrmSangria.bt_cancelar1Click(Sender: TObject);
begin
  close;
end;

procedure TfrmSangria.bt_ok1Click(Sender: TObject);
begin
  if ed_valor.value <= 0 then begin
    Application.MessageBox('Favor informar um valor MAIOR que ZERO!','Erro',mb_ok+mb_iconerror);
    ed_valor.setfocus;
    exit;
  end;

  repeat
    // extrair do ecf
    if frmPrincipal.TipoImpressora = fiscal then begin
      sNumero_cupom := cECF_COO_Nao_Fiscal(iECF_Modelo);
      sMsg := cECF_Sangria(iECF_Modelo,ed_valor.Value);

    end else begin




      sNumero_cupom := zerar(FloatToStr( max('')),5);
      //fxSangria.ShowReport();
      //fxSangria.LoadFromFile(ExtractFilePath(application.ExeName) + '\rel\F000001.fr3');
      frmModulo.Qremitente.Close;
      frmModulo.Qremitente.Open;
      if Editar then
        //fxSangria.DesignReport
      else
        //fxSangria.ShowReport;
      sMsg := 'OK';
      sMsg := Imp_Sangria(sPortaNaoFiscal,ed_valor.Value);
      if Length(sNumero_Cupom) = 5 then
      sNumero_Cupom := '9' + sNumero_Cupom;
    end;


    if sMsg <> 'OK' then begin
      if application.MessageBox(pwidechar('Erro a lançar a sangria no ECF!'+#13+
                                          'Mensagem: '+sMsg+#13+
                                          'Deseja tentar outra vez?'),'Erro',mb_yesno+mb_iconerror)=
                                          idno then
                                                break;
    end else begin
      // extrair o numero dos contadores
      if frmPrincipal.TipoImpressora = fiscal then
        sGNF := cECF_Numero_Contador_Operacao_NF(iECF_Modelo)
      else begin
        sGNF := zerar(FloatToStr(Max('')),5  );
        if Length(sGNF) = 5 then
          sNumero_cupom := Zerar( FloatToStr( Max('') ),5 );


      end;

      with frmModulo do begin

      //Lançãmento servidor
      {  Begin

        Application.ProcessMessages;

        qrsangria_servidor.Close;
        qrsangria_servidor.SQL.Clear;
        qrsangria_servidor.SQL.Add('insert into NAO_FISCAL');
        qrsangria_servidor.SQL.Add('(codigo,ecf,data,indice,descricao,valor,hora,COO,GNF,CDC,GRG,DENOMINACAO,codVendedor)');
        qrsangria_servidor.SQL.Add('values');
        qrsangria_servidor.SQL.Add('(:codigo,:ecf,:data,:indice,:descricao,:valor,:hora,:COO,:GNF,:CDC,:GRG,:DENOMINACAO,:codVendedor)');

        qrsangria_servidor.Params.ParamByName('codigo').asstring := codifica_cupom;
        qrsangria_servidor.Params.ParamByName('ecf').AsString := sECF_Serial;
        qrsangria_servidor.Params.ParamByName('data').asdatetime := dData_Sistema;
        qrsangria_servidor.Params.ParamByName('indice').asstring := sIndice_Sangria;
        qrsangria_servidor.Params.ParamByName('descricao').asstring := 'SANGRIA';
        qrsangria_servidor.Params.ParamByName('valor').asfloat := ed_valor.value;
        qrsangria_servidor.Params.ParamByName('hora').Astime := strtotime(copy(cECF_Data_Hora(iECF_Modelo),12,8));
        qrsangria_servidor.Params.ParamByName('COO').asstring := sNumero_Cupom;
        qrsangria_servidor.Params.ParamByName('GNF').asstring := sGNF;
        qrsangria_servidor.Params.ParamByName('CDC').Clear;
        qrsangria_servidor.Params.ParamByName('GRG').clear;
        qrsangria_servidor.Params.ParamByName('DENOMINACAO').asstring := 'CN';
        qrsangria_servidor.Params.ParamByName('codVendedor').asstring := frmvenda.lbcod_operador.Caption;
        qrsangria_servidor.Execute;

        Begin
          qrobs_sangriaSV.Close;
          qrobs_sangriaSV.sql.clear;
          qrobs_sangriaSV.sql.add('update nao_fiscal set pego_porquem = :OBS ');
          qrobs_sangriaSV.sql.add('where');
          qrobs_sangriaSV.sql.add('CODIGO = :codigo');
          qrobs_sangriaSV.ParamByName('codigo').asstring := codifica_cupom;
          qrobs_sangriaSV.Parambyname('OBS').asstring := Edit2.text;
          qrobs_sangriaSV.Execute

         end;
       End;}

       //Lançãmento BD local
        Begin
        spNao_Fiscal.close;
        spNao_Fiscal.ParamByName('codigo').asstring := codifica_cupom;
        spNao_Fiscal.ParamByName('ecf').AsString := sECF_Serial;
        spNao_Fiscal.ParamByName('data').asdatetime := dData_Sistema;
        spNao_Fiscal.ParamByName('indice').asstring := sIndice_Sangria;
        spNao_Fiscal.ParamByName('descricao').asstring := 'SANGRIA';
        spNao_Fiscal.ParamByName('valor').asfloat := ed_valor.value;
        spNao_fiscal.ParamByName('hora').Astime := strtotime(copy(cECF_Data_Hora(iECF_Modelo),12,8));
        spNao_fiscal.ParamByName('COO').asstring := sNumero_Cupom;
        spNao_fiscal.ParamByName('GNF').asstring := sGNF;
        spNao_fiscal.ParamByName('CDC').Clear;
        spNao_fiscal.ParamByName('GRG').clear;
        spNao_fiscal.ParamByName('DENOMINACAO').asstring := 'CN';
        spNao_fiscal.ParamByName('codVendedor').asstring := frmvenda.lbcod_operador.Caption;
        spNao_Fiscal.Prepare;
        spNao_Fiscal.Execute;

        Begin
          qrobs_sangria.Close;
          qrobs_sangria.sql.clear;
          qrobs_sangria.sql.add('update nao_fiscal set pego_porquem = :OBS ');
          qrobs_sangria.sql.add('where');
          qrobs_sangria.sql.add('CODIGO = :codigo');
          qrobs_sangria.ParamByName('codigo').asstring := codifica_cupom;
          qrobs_sangria.Parambyname('OBS').asstring := Edit2.text;
          qrobs_sangria.ExecSQL;
         end;
       End;




                qrsangria.close;
                qrsangria.sql.clear;
                qrsangria.sql.add('select nf.coo, nf.data, nf.descricao, nf.valor,');
                qrsangria.sql.add('nf.hora, nf.codvendedor, vd.nome,');
                qrsangria.sql.add('nf.pego_porquem');
                qrsangria.sql.add('from nao_fiscal nf, c000008 vd');
                qrsangria.sql.add('where vd.codigo = nf.codvendedor and');
                qrsangria.sql.add('nf.CODIGO = :codigo');
                qrsangria.ParamByName('codigo').asstring := codifica_cupom;
                qrsangria.ExecSQL;

                {fxSangria.PrepareReport;
                fxSangria.Print;}
                fxSangria.ShowReport();


      end;
    end;
  until sMsg = 'OK';
  close;
end;

procedure TfrmSangria.Cancelar1Click(Sender: TObject);
begin
   close;
end;


procedure TfrmSangria.Edit2Exit(Sender: TObject);
begin
   bt_ok1.SetFocus;
end;

procedure TfrmSangria.ed_valorEnter(Sender: TObject);
begin
  Edit2.SetFocus;
end;

procedure TfrmSangria.ed_valorExit(Sender: TObject);
begin
Edit2.SetFocus;
end;

end.
