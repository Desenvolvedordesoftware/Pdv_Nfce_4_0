unit splashpdv;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, vcl.imaging.GIFImg, JvGIF, Vcl.ExtCtrls,
  Data.DB, MemDS, DBAccess, Uni, UniProvider, InterBaseUniProvider,
  NxColumnClasses, NxColumns, NxScrollControl, NxCustomGridControl,
  NxCustomGrid, NxGrid;

type
  Tfrmsplashpdv = class(TForm)
    grid: TNextGrid;
    NxNumberColumn2: TNxNumberColumn;
    NxTextColumn1: TNxTextColumn;
    NxTextColumn2: TNxTextColumn;
    NxImageColumn1: TNxImageColumn;
    NxCheckBoxColumn1: TNxCheckBoxColumn;
    conexao_servidor: TUniConnection;
    conexao_pdv: TUniConnection;
    InterBaseUniProvider1: TInterBaseUniProvider;
    qrbanco: TUniQuery;
    qrIBPT: TUniQuery;
    qrIBPTCODIGO: TStringField;
    qrIBPTEX: TStringField;
    qrIBPTTABELA: TIntegerField;
    qrIBPTALIQNAC: TFloatField;
    qrIBPTALIQIMP: TFloatField;
    qrIBPTNCM: TStringField;
    qrConfServer: TUniQuery;
    qrConfServerACRESCIMO_PRODUTO: TFloatField;
    qrConfServerDESCONTO_PRODUTO: TFloatField;
    qrMovCartao: TUniQuery;
    qrPDV: TUniQuery;
    qrServidor: TUniQuery;
    qrServidor_Tabela: TUniQuery;
    qrcaixa_mov: TUniQuery;
    qrconfig: TUniQuery;
    qrpdv2: TUniQuery;
    qrCrediario: TUniQuery;
    qrMestre: TUniQuery;
    qrForma: TUniQuery;
    qrpdv3: TUniQuery;
    qrPDV_Tabela: TUniQuery;
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmsplashpdv: Tfrmsplashpdv;

implementation

{$R *.dfm}

procedure Tfrmsplashpdv.FormShow(Sender: TObject);
var
  I, x, y, iprest: INTEGER;
  scst: string;
  bflag: boolean;
  scod_cupom: string;
  scod_venda: string;
  bachou: boolean;

  //situacao caixa

  sit_caixa: string;

(* Lista de Formas de Pagamento que exigem tratamento especial no fechamento da venda*)
  lForma_pgto_Cheque_Avista, lForma_pgto_Cheque_Aprazo, lForma_pgto_Crediario,
    lForma_pgto_Cartao_Credito, lForma_pgto_Cartao_Debito, lForma_pgto_dinheiro,
    lForma_pgto_Convenio: String;

  rpercentual: Real;

  SCOD_REDUCAO: string;
  MemoryStream : TMemoryStream;
  Bitmap : TBitmap;
  iparcela, itotal_parcela: Integer;
  valorparcela, restante:Double;

begin
  try



                     // S E R V I D O R   PARA  E S T A C A O

              try
                   // 1 - PRODUTO
                ;

                qrConfServer.Close;
                qrConfServer.Open;

                while not qrservidor.eof do
                begin
                  Application.ProcessMessages;

                  bflag := true;
                  case qrservidor.fieldbyname('movimento').asinteger of
                    1: {inclusao}
                      begin

                        qrServidor_Tabela.Close;
                        qrServidor_Tabela.sql.clear;
                        qrServidor_Tabela.sql.add('select c000025.*, c000100.Estoque_atual');
                        qrServidor_Tabela.sql.add('from c000025, c000100');
                        qrServidor_Tabela.sql.add('where c000025.codigo = c000100.codproduto');
                        qrservidor_tabela.sql.add('and c000025.codigo = ''' + qrservidor.fieldbyname('codregistro').asstring + '''');
                        qrservidor_tabela.open;

                        if qrservidor_tabela.RecordCount > 0 then
                        begin
                          try
                            qrpdv.close;
                            qrpdv.sql.clear;
                            qrpdv.sql.add('insert into ESTOQUE (');
                            qrpdv.sql.add('CODIGO,');
                            qrpdv.sql.add('COD_BARRA,');
                            qrpdv.sql.add('NOME,');
                            qrpdv.sql.add('UNIDADE,');
                            qrpdv.sql.add('PRECO_VENDA,');
                            qrpdv.sql.add('PRECO_VENDA2,');
                            qrpdv.sql.add('PRECO_PROMOCAO,');
                            qrpdv.sql.add('INICIO_PROMOCAO,');
                            qrpdv.sql.add('FINAL_PROMOCAO,');
                            qrpdv.sql.add('CST,');
                            qrpdv.sql.add('ALIQUOTA,');
                            qrpdv.sql.add('DESCONTO_MAXIMO,');
                            qrpdv.sql.add('ACRECIMO_MAXIMO,');
                            qrpdv.sql.add('ST,');
                            qrpdv.sql.add('ESTOQUE,');
                            qrpdv.sql.add('IAT,');
                            qrpdv.sql.add('IPPT,');
                            qrpdv.sql.add('SITUACAO,');
                            qrpdv.sql.add('CODORIGINAL,');
                            qrpdv.sql.add('CFOP,');
                            qrpdv.sql.add('NCM,');
                            qrpdv.sql.add('ALIQNACIONAL,');
                            qrpdv.sql.add('fotobd');




                            qrpdv.sql.add(') values (');

                            qrpdv.sql.add(':CODIGO,');
                            qrpdv.sql.add(':COD_BARRA,');
                            qrpdv.sql.add(':NOME,');
                            qrpdv.sql.add(':UNIDADE,');
                            qrpdv.sql.add(':PRECO_VENDA,');
                            qrpdv.sql.add(':PRECO_VENDA2,');
                            qrpdv.sql.add(':PRECO_PROMOCAO,');
                            qrpdv.sql.add(':INICIO_PROMOCAO,');
                            qrpdv.sql.add(':FINAL_PROMOCAO,');
                            qrpdv.sql.add(':CST,');
                            qrpdv.sql.add(':ALIQUOTA,');
                            qrpdv.sql.add(':DESCONTO_MAXIMO,');
                            qrpdv.sql.add(':ACRECIMO_MAXIMO,');
                            qrpdv.sql.add(':ST,');
                            qrpdv.sql.add(':ESTOQUE,');
                            qrpdv.sql.add(':IAT,');
                            qrpdv.sql.add(':IPPT,');
                            qrpdv.sql.add(':SITUACAO,');
                            qrpdv.sql.add(':CODORIGINAL,');
                            qrpdv.sql.add(':CFOP,');
                            qrpdv.sql.add(':NCM,');
                            qrpdv.sql.add(':ALIQNACIONAL,');
                            qrpdv.sql.add(':fotobd');


                            qrpdv.sql.add(')');

                            qrpdv.parambyname('CODIGO').asstring := qrservidor_tabela.fieldbyname('codigo').asstring;
                            qrpdv.parambyname('COD_BARRA').asstring := copy(qrservidor_tabela.fieldbyname('codbarra').asstring, 1, 15);
                            qrpdv.parambyname('NOME').asstring := copy(qrservidor_tabela.fieldbyname('produto').asstring, 1, 80);
                            qrpdv.parambyname('UNIDADE').AsString := qrservidor_tabela.fieldbyname('unidade').asstring;
                            qrpdv.parambyname('PRECO_VENDA').asfloat := qrservidor_tabela.fieldbyname('precovenda').asstring;
                            qrpdv.parambyname('PRECO_VENDA2').asfloat := qrservidor_tabela.fieldbyname('precovenda1').asstring;
                            qrpdv.parambyname('PRECO_PROMOCAO').asfloat := qrservidor_tabela.fieldbyname('preco_promocao').asstring;
                            qrpdv.parambyname('INICIO_PROMOCAO').asdatetime := qrservidor_tabela.fieldbyname('data_promocao').asdatetime;
                            qrpdv.parambyname('FINAL_PROMOCAO').asdatetime := qrservidor_tabela.fieldbyname('fim_promocao').asdatetime;
                            qrpdv.parambyname('CST').asstring := qrservidor_tabela.fieldbyname('cst').asstring;
                            qrpdv.parambyname('ALIQUOTA').asfloat := qrservidor_tabela.fieldbyname('aliquota').asfloat;
                            qrpdv.parambyname('DESCONTO_MAXIMO').asfloat := qrConfServerDESCONTO_PRODUTO.AsFloat;
                            qrpdv.parambyname('ACRECIMO_MAXIMO').asfloat := qrConfServerACRESCIMO_PRODUTO.AsFloat;
                            qrpdv.parambyname('SITUACAO').AsInteger := 0;
                            qrpdv.parambyname('CODORIGINAL').asstring := copy(qrservidor_tabela.fieldbyname('codoriginal').asstring, 1, 15);
                            qrpdv.parambyname('CFOP').AsString := qrservidor_tabela.fieldbyname('IND_CFOP_VENDA_DENTRO').asstring;


                            scst := qrservidor_tabela.fieldbyname('cst').asstring;

                            if (scst = '060') or
                              (scst = '010') or
                              (scst = '070') then qrpdv.Params.ParamByName('st').asSTRING := 'F'
                            else
                              if (scst = '040') or
                                (scst = '030') then qrpdv.Params.ParamByName('st').asSTRING := 'I'
                              else
                                if (scst = '041') or
                                  (scst = '050') or
                                  (scst = '051') or
                                  (scst = '090') then qrpdv.Params.ParamByName('st').asSTRING := 'N'
                                else
                                  qrpdv.ParamByName('st').asSTRING := 'T';

                            qrpdv.parambyname('ESTOQUE').asfloat := qrservidor_tabela.fieldbyname('estoque_atual').asfloat;
                            qrpdv.parambyname('IAT').asstring := qrservidor_tabela.fieldbyname('IAT').AsString;
                            qrpdv.parambyname('IPPT').asstring := qrservidor_tabela.fieldbyname('IPPT').AsString;
                            qrpdv.parambyname('NCM').asstring := qrservidor_tabela.fieldbyname('CLASSIFICACAO_FISCAL').AsString;
                            if not qrservidor_tabela.fieldbyname('fotobd').IsNull then begin
                              MemoryStream := TMemoryStream.Create;
                              (qrservidor_tabela.fieldbyname('fotobd') as tblobfield).SaveToStream(MemoryStream);
                             qrpdv.parambyname('fotobd').LoadFromStream(MemoryStream,ftGraphic);
                              freeandnil(MemoryStream);
                            end else
                              qrpdv.parambyname('fotobd').Clear;
                            qrIBPT.Close;
                            qrIBPT.ParamByName('NCM').Value := qrservidor_tabela.fieldbyname('CLASSIFICACAO_FISCAL').AsString;
                            qrIBPT.Open;
                            if not qrIBPT.IsEmpty then
                              qrpdv.parambyname('ALIQNACIONAL').AsFloat := qrIBPTALIQNAC.AsFloat
                            else
                              qrpdv.parambyname('ALIQNACIONAL').AsFloat := 0;
                            qrpdv.ExecSQL;
                          except
                            on E: Exception do
                            begin

                              qrPDV.close;
                              qrPDV.sql.clear;
                              qrpdv.sql.Add('select codigo from estoque');
                              qrPDV.sql.Add('where codigo = ' + inttostr(StrToInt(qrservidor.fieldbyname('codregistro').asstring)));
                              qrpdv.open;
                              if qrPDV.RecordCount = 0 then bflag := false;
                            end;
                          end;
                        end;

                      end;
                    2: {alteracao}
                      begin

                        qrServidor_Tabela.Close;
                        qrServidor_Tabela.sql.clear;
                        qrServidor_Tabela.sql.add('select c000025.*, c000100.Estoque_atual');
                        qrServidor_Tabela.sql.add('from c000025, c000100');
                        qrServidor_Tabela.sql.add('where c000025.codigo = c000100.codproduto');
                        qrservidor_tabela.sql.add('and c000025.codigo = ''' + qrservidor.fieldbyname('codregistro').asstring + '''');
                        qrservidor_tabela.open;

                        if qrservidor_tabela.RecordCount > 0 then
                        begin

                          qrpdv_tabela.close;
                          qrpdv_tabela.sql.clear;
                          qrpdv_tabela.sql.add('select * from ESTOQUE where codigo = ' + inttostr(strtoint(qrservidor_tabela.fieldbyname('codigo').asstring)));
                          qrpdv_tabela.Open;

                          if qrpdv_tabela.RecordCount > 0 then
                          begin
                         // achou o registro e processar com a atualizacao
                             try
                              qrpdv.close;
                              qrpdv.sql.clear;
                              qrpdv.sql.add('update ESTOQUE set');
                              qrpdv.sql.add('COD_BARRA = :COD_BARRA,');
                              qrpdv.sql.add('NOME = :NOME,');
                              qrpdv.sql.add('UNIDADE = :UNIDADE,');
                              qrpdv.sql.add('PRECO_VENDA = :PRECO_VENDA,');
                              qrpdv.sql.add('PRECO_VENDA2 = :PRECO_VENDA2,');
                              qrpdv.sql.add('PRECO_PROMOCAO = :PRECO_PROMOCAO,');
                              qrpdv.sql.add('INICIO_PROMOCAO = :INICIO_PROMOCAO,');
                              qrpdv.sql.add('FINAL_PROMOCAO = :FINAL_PROMOCAO,');
                              qrpdv.sql.add('CST = :CST,');
                              qrpdv.sql.add('ALIQUOTA = :ALIQUOTA,');
                              qrpdv.sql.add('DESCONTO_MAXIMO = :DESCONTO_MAXIMO,');
                              qrpdv.sql.add('ACRECIMO_MAXIMO = :ACRECIMO_MAXIMO,');
                              qrpdv.sql.add('ST = :ST,');
                              qrpdv.sql.add('ESTOQUE = :ESTOQUE,');
                              qrpdv.sql.add('IAT = :IAT,');
                              qrpdv.sql.add('IPPT = :IPPT,');
                              qrpdv.sql.add('SITUACAO = :SITUACAO,');
                              qrpdv.sql.add('CODORIGINAL = :CODORIGINAL,');
                              qrpdv.sql.add('CFOP = :CFOP,');
                              qrpdv.sql.add('NCM = :NCM,');
                              qrpdv.sql.add('ALIQNACIONAL = :ALIQNACIONAL,');
                              qrpdv.sql.add('fotobd = :fotobd');


                              qrpdv.sql.add('where codigo = :codigo');

                              qrpdv.parambyname('CODIGO').asinteger := strtoint(qrservidor_tabela.fieldbyname('codigo').asstring);
                              qrpdv.parambyname('COD_BARRA').asstring := copy(qrservidor_tabela.fieldbyname('codbarra').asstring, 1, 15);
                              qrpdv.parambyname('NOME').asstring := copy(qrservidor_tabela.fieldbyname('produto').asstring, 1, 80);
                              qrpdv.parambyname('UNIDADE').AsString := qrservidor_tabela.fieldbyname('unidade').asstring;
                              qrpdv.parambyname('PRECO_VENDA').asfloat := copy(qrservidor_tabela.fieldbyname('precovenda').asfloat, 2);
                              qrpdv.parambyname('PRECO_VENDA2').asfloat := copy(qrservidor_tabela.fieldbyname('precovenda1').asfloat, 2);
                              qrpdv.parambyname('PRECO_PROMOCAO').asfloat := copy(qrservidor_tabela.fieldbyname('preco_promocao').asfloat, 2);
                              qrpdv.parambyname('INICIO_PROMOCAO').asdatetime := qrservidor_tabela.fieldbyname('data_promocao').asdatetime;
                              qrpdv.parambyname('FINAL_PROMOCAO').asdatetime := qrservidor_tabela.fieldbyname('fim_promocao').asdatetime;
                              qrpdv.parambyname('CST').asstring := qrservidor_tabela.fieldbyname('cst').asstring;
                              qrpdv.parambyname('ALIQUOTA').asfloat := qrservidor_tabela.fieldbyname('aliquota').asfloat;
                              qrpdv.parambyname('DESCONTO_MAXIMO').asfloat := qrConfServerDESCONTO_PRODUTO.AsFloat;
                              qrpdv.parambyname('ACRECIMO_MAXIMO').asfloat := qrConfServerACRESCIMO_PRODUTO.AsFloat;
                              qrpdv.parambyname('SITUACAO').AsInteger := qrservidor_tabela.fieldbyname('SITUACAO').AsInteger;
                              qrpdv.parambyname('CODORIGINAL').asstring := copy(qrservidor_tabela.fieldbyname('CODORIGINAL').asstring, 1, 15);
                              qrpdv.parambyname('CFOP').AsString := qrservidor_tabela.fieldbyname('IND_CFOP_VENDA_DENTRO').asstring;


                              scst := qrservidor_tabela.fieldbyname('cst').asstring;

                              if (scst = '060') or
                                (scst = '010') or
                                (scst = '070') then qrpdv.Params.ParamByName('st').asSTRING := 'F'
                              else
                                if (scst = '040') or
                                  (scst = '030') then qrpdv.Params.ParamByName('st').asSTRING := 'I'
                                else
                                  if (scst = '041') or
                                    (scst = '050') or
                                    (scst = '051') or
                                    (scst = '090') then qrpdv.Params.ParamByName('st').asSTRING := 'N'
                                  else
                                    qrpdv.ParamByName('st').asSTRING := 'T';

                              qrpdv.parambyname('ESTOQUE').asfloat := qrservidor_tabela.fieldbyname('estoque_atual').asfloat;
                              qrpdv.parambyname('IAT').asstring := qrservidor_tabela.fieldbyname('IAT').AsString;
                              qrpdv.parambyname('IPPT').asstring := qrservidor_tabela.fieldbyname('IPPT').AsString;
                              qrpdv.parambyname('NCM').asstring := qrservidor_tabela.fieldbyname('CLASSIFICACAO_FISCAL').AsString;
                              if not qrservidor_tabela.fieldbyname('fotobd').IsNull then begin
                                MemoryStream := TMemoryStream.Create;
                                (qrservidor_tabela.fieldbyname('fotobd') as tblobfield).SaveToStream(MemoryStream);

                                qrpdv.parambyname('fotobd').LoadFromStream(MemoryStream,ftGraphic);
                                freeandnil(MemoryStream);
                              end else
                                qrpdv.parambyname('fotobd').Clear;
                              qrIBPT.Close;
                              qrIBPT.ParamByName('NCM').Value := qrservidor_tabela.fieldbyname('CLASSIFICACAO_FISCAL').AsString;
                              qrIBPT.Open;
                              if not qrIBPT.IsEmpty then
                                qrpdv.parambyname('ALIQNACIONAL').AsFloat := qrIBPTALIQNAC.AsFloat
                              else
                                qrpdv.parambyname('ALIQNACIONAL').AsFloat := 0;
                              qrpdv.ExecSQL;

                              qrpdv.ExecSQL;
                            except
                             bflag := false;
                            end;
                          end
                          else
                          begin
                         // nao existe este registro no pdv... fazer a inclusao

                            try
                              qrpdv.close;
                              qrpdv.sql.clear;
                              qrpdv.sql.add('insert into ESTOQUE (');
                              qrpdv.sql.add('CODIGO,');
                              qrpdv.sql.add('COD_BARRA,');
                              qrpdv.sql.add('NOME,');
                              qrpdv.sql.add('UNIDADE,');
                              qrpdv.sql.add('PRECO_VENDA,');
                              qrpdv.sql.add('PRECO_VENDA2,');
                              qrpdv.sql.add('PRECO_PROMOCAO,');
                              qrpdv.sql.add('INICIO_PROMOCAO,');
                              qrpdv.sql.add('FINAL_PROMOCAO,');
                              qrpdv.sql.add('CST,');
                              qrpdv.sql.add('ALIQUOTA,');
                              qrpdv.sql.add('DESCONTO_MAXIMO,');
                              qrpdv.sql.add('ACRECIMO_MAXIMO,');
                              qrpdv.sql.add('ST,');
                              qrpdv.sql.add('ESTOQUE,');
                              qrpdv.sql.add('IAT,');
                              qrpdv.sql.add('IPPT,');
                              qrpdv.sql.add('CFOP,');
                              qrpdv.sql.add('NCM');
                              qrpdv.sql.add('SITUACAO,');
                              qrpdv.sql.add('CODORIGINAL,');
                              qrpdv.sql.add('fotobd');



                              qrpdv.sql.add(') values (');

                              qrpdv.sql.add(':CODIGO,');
                              qrpdv.sql.add(':COD_BARRA,');
                              qrpdv.sql.add(':NOME,');
                              qrpdv.sql.add(':UNIDADE,');
                              qrpdv.sql.add(':PRECO_VENDA,');
                              qrpdv.sql.add(':PRECO_VENDA2,');
                              qrpdv.sql.add(':PRECO_PROMOCAO,');
                              qrpdv.sql.add(':INICIO_PROMOCAO,');
                              qrpdv.sql.add(':FINAL_PROMOCAO,');
                              qrpdv.sql.add(':CST,');
                              qrpdv.sql.add(':ALIQUOTA,');
                              qrpdv.sql.add(':DESCONTO_MAXIMO,');
                              qrpdv.sql.add(':ACRECIMO_MAXIMO,');
                              qrpdv.sql.add(':ST,');
                              qrpdv.sql.add(':ESTOQUE,');
                              qrpdv.sql.add(':IAT,');
                              qrpdv.sql.add(':IPPT,');
                              qrpdv.sql.add(':CFOP,');
                              qrpdv.sql.add(':NCM');
                              qrpdv.sql.add(':SITUACAO,');
                              qrpdv.sql.add(':CODORIGINAL,');
                              qrpdv.sql.add(':fotobd');


                              qrpdv.sql.add(')');

                              qrpdv.parambyname('CODIGO').asstring := qrservidor_tabela.fieldbyname('codigo').asstring;
                              qrpdv.parambyname('COD_BARRA').asstring := copy(qrservidor_tabela.fieldbyname('codbarra').asstring, 1, 15);
                              qrpdv.parambyname('NOME').asstring := copy(qrservidor_tabela.fieldbyname('produto').asstring, 1, 80);
                              qrpdv.parambyname('UNIDADE').AsString := qrservidor_tabela.fieldbyname('unidade').asstring;
                              qrpdv.parambyname('PRECO_VENDA').asfloat := Arredondar( qrservidor_tabela.fieldbyname('precovenda').asfloat,2);
                              qrpdv.parambyname('PRECO_VENDA2').asfloat := Arredondar( qrservidor_tabela.fieldbyname('precovenda1').asfloat,2);
                              qrpdv.parambyname('PRECO_PROMOCAO').asfloat := Arredondar( qrservidor_tabela.fieldbyname('preco_promocao').asfloat,2);
                              qrpdv.parambyname('INICIO_PROMOCAO').asdatetime := qrservidor_tabela.fieldbyname('data_promocao').asdatetime;
                              qrpdv.parambyname('FINAL_PROMOCAO').asdatetime := qrservidor_tabela.fieldbyname('fim_promocao').asdatetime;
                              qrpdv.parambyname('CST').asstring := qrservidor_tabela.fieldbyname('cst').asstring;
                              qrpdv.parambyname('ALIQUOTA').asfloat := qrservidor_tabela.fieldbyname('aliquota').asfloat;
                              qrpdv.parambyname('DESCONTO_MAXIMO').asfloat := qrConfServerDESCONTO_PRODUTO.AsFloat;
                              qrpdv.parambyname('ACRECIMO_MAXIMO').asfloat := qrConfServerACRESCIMO_PRODUTO.AsFloat;
                              qrpdv.parambyname('SITUACAO').AsInteger := qrservidor_tabela.fieldbyname('SITUACAO').AsInteger;
                              qrpdv.parambyname('CODORIGINAL').asstring := copy(qrservidor_tabela.fieldbyname('CODORIGINAL').asstring, 1, 15);
                              qrpdv.parambyname('CFOP').AsString := qrservidor_tabela.fieldbyname('IND_CFOP_VENDA_DENTRO').asstring;
                              qrpdv.parambyname('NCM').asstring := qrservidor_tabela.fieldbyname('CLASSIFICACAO_FISCAL').AsString;

                              if not qrservidor_tabela.fieldbyname('fotobd').IsNull then begin
                                MemoryStream := TMemoryStream.Create;

                                (qrservidor_tabela.fieldbyname('fotobd') as tblobfield).SaveToStream(MemoryStream);

                                qrpdv.parambyname('fotobd').LoadFromStream(MemoryStream,ftGraphic);
                                freeandnil(MemoryStream);
                              end else
                                qrpdv.parambyname('fotobd').Clear;

                              scst := qrservidor_tabela.fieldbyname('cst').asstring;

                              if (scst = '060') or
                                (scst = '010') or
                                (scst = '070') then qrpdv.Params.ParamByName('st').asSTRING := 'F'
                              else
                                if (scst = '040') or
                                  (scst = '030') then qrpdv.Params.ParamByName('st').asSTRING := 'I'
                                else
                                  if (scst = '041') or
                                    (scst = '050') or
                                    (scst = '051') or
                                    (scst = '090') then qrpdv.Params.ParamByName('st').asSTRING := 'N'
                                  else
                                    qrpdv.ParamByName('st').asSTRING := 'T';

                              qrpdv.parambyname('ESTOQUE').asfloat := qrservidor_tabela.fieldbyname('estoque_atual').asfloat;
                              qrpdv.parambyname('IAT').asstring := qrservidor_tabela.fieldbyname('IAT').AsString;
                              qrpdv.parambyname('IPPT').asstring := qrservidor_tabela.fieldbyname('IPPT').AsString;
                              qrpdv.ExecSQL;
                            except
                             qrPDV.close;
                              qrPDV.sql.clear;
                              qrpdv.sql.Add('select codigo from estoque');
                              qrPDV.sql.Add('where codigo = ' + inttostr(StrToInt(qrservidor.fieldbyname('codregistro').asstring)));
                              qrpdv.open;
                              if qrPDV.RecordCount = 0 then bflag := false;
                            end;
                          end;
                        end;
                      end;
                    3: {exclusao}
                      begin
                        try
                          qrpdv.close;
                          qrpdv.sql.clear;
                          qrpdv.sql.add('delete from estoque where codigo = :codigo');
                          qrpdv.parambyname('CODIGO').asinteger := strtoint(qrservidor.fieldbyname('codregistro').asstring);
                          qrpdv.ExecSQL;
                        except
                          bflag := FALSE;
                        end;
                      end;
                  end;




                end;


             // 2 - CLIENTE


                while not qrservidor.eof do
                begin
                  Application.ProcessMessages;

                  bflag := TRUE;
                  case qrservidor.fieldbyname('movimento').asinteger of
                    1: {inclusao}
                      begin
                       qrServidor_Tabela.Close;
                        qrServidor_Tabela.sql.clear;
                        qrServidor_Tabela.sql.add('select *');
                        qrServidor_Tabela.sql.add('from C000007');
                        qrServidor_Tabela.sql.add('where codigo =  ''' + qrservidor.fieldbyname('codregistro').asstring + '''');
                        qrservidor_tabela.open;

                        try
                          if qrservidor_tabela.RecordCount > 0 then
                          begin
                            qrpdv.close;
                            qrpdv.sql.clear;
                            qrpdv.sql.add('insert into CLIENTE (');

                            qrpdv.sql.add('CODIGO,');
                            qrpdv.sql.add('NOME,');
                            qrpdv.sql.add('CPF,');
                            qrpdv.sql.add('ENDERECO,');
                            qrpdv.sql.add('COMPLEMENTO,');
                            qrpdv.sql.add('BAIRRO,');
                            qrpdv.sql.add('CIDADE,');
                            qrpdv.sql.add('UF,');
                            qrpdv.sql.add('CEP,');
                            qrpdv.sql.add('SITUACAO,');
                            qrpdv.sql.add('OBS,');
                            qrpdv.sql.add('LIMITE,');
                            qrpdv.sql.add('UTILIZADO,');
                            qrpdv.sql.add('DISPONIVEL,');
                            qrpdv.sql.add('ATUALIZADO');
                            qrpdv.sql.add(') values (');

                            qrpdv.sql.add(':CODIGO,');
                            qrpdv.sql.add(':NOME,');
                            qrpdv.sql.add(':CPF,');
                            qrpdv.sql.add(':ENDERECO,');
                            qrpdv.sql.add(':COMPLEMENTO,');
                            qrpdv.sql.add(':BAIRRO,');
                            qrpdv.sql.add(':CIDADE,');
                            qrpdv.sql.add(':UF,');
                            qrpdv.sql.add(':CEP,');
                            qrpdv.sql.add(':SITUACAO,');
                            qrpdv.sql.add(':OBS,');
                            qrpdv.sql.add(':LIMITE,');
                            qrpdv.sql.add(':UTILIZADO,');
                            qrpdv.sql.add(':DISPONIVEL,');
                            qrpdv.sql.add(':ATUALIZADO');

                            qrpdv.sql.add(')');

                            qrpdv.parambyname('CODIGO').asstring := qrservidor_tabela.fieldbyname('codigo').asstring;
                            qrpdv.parambyname('NOME').asstring := qrservidor_tabela.fieldbyname('nome').asstring;
                            qrpdv.parambyname('CPF').asstring := qrservidor_tabela.fieldbyname('cpf').asstring;
                            qrpdv.parambyname('ENDERECO').asstring := qrservidor_tabela.fieldbyname('endereco').asstring;
                            qrpdv.parambyname('COMPLEMENTO').asstring := qrservidor_tabela.fieldbyname('complemento').asstring;
                            qrpdv.parambyname('BAIRRO').asstring := qrservidor_tabela.fieldbyname('bairro').asstring;
                            qrpdv.parambyname('CIDADE').asstring := qrservidor_tabela.fieldbyname('cidade').asstring;
                            qrpdv.parambyname('UF').asstring := qrservidor_tabela.fieldbyname('uf').asstring;
                            qrpdv.parambyname('CEP').asstring := qrservidor_tabela.fieldbyname('cep').asstring;
                            if trim(qrservidor_tabela.fieldbyname('situacao').asstring) = '' then
                              qrpdv.parambyname('SITUACAO').asstring := '1'
                            else
                              qrpdv.parambyname('SITUACAO').asstring := qrservidor_tabela.fieldbyname('situacao').asstring;
                            qrpdv.parambyname('OBS').Asstring :=
                              qrservidor_tabela.fieldbyname('obs1').asstring + #13 +
                              qrservidor_tabela.fieldbyname('obs2').asstring + #13 +
                              qrservidor_tabela.fieldbyname('obs3').asstring + #13 +
                              qrservidor_tabela.fieldbyname('obs4').asstring + #13 +
                              qrservidor_tabela.fieldbyname('obs5').asstring + #13 +
                              qrservidor_tabela.fieldbyname('obs6').asstring;
                            qrpdv.parambyname('LIMITE').asFLOAT := qrservidor_tabela.fieldbyname('LIMITE').AsFloat;
                            qrpdv.parambyname('UTILIZADO').asfloat := verifica_crediario(qrservidor_tabela.fieldbyname('codigo').asstring);
                            qrpdv.parambyname('DISPONIVEL').asfloat := qrpdv.parambyname('LIMITE').asFLOAT - qrpdv.parambyname('UTILIZADO').asfloat;
                            qrpdv.parambyname('ATUALIZADO').asstring := datetostr(date) + ' AS ' + TimeToStr(TIME);
                            qrpdv.ExecSQL;
                          end;
                        except
                          qrPDV.close;
                          qrpdv.sql.clear;
                          qrPDV.sql.Add('select codigo from CLIENTE');
                          qrpdv.sql.Add('where codigo = ' + inttostr(StrToInt(qrservidor.fieldbyname('codregistro').asstring)));
                          qrPDV.Open;
                          if qrpdv.RecordCount = 0 then bflag := false;
                        end;
                      end;
                    2: {alteracao}
                      begin
                        qrServidor_Tabela.Close;
                        qrServidor_Tabela.sql.clear;
                        qrServidor_Tabela.sql.add('select *');
                        qrServidor_Tabela.sql.add('from C000007');
                        qrServidor_Tabela.sql.add('where codigo =  ''' + qrservidor.fieldbyname('codregistro').asstring + '''');
                        qrservidor_tabela.open;

                        if qrservidor_tabela.RecordCount > 0 then
                        begin
                          qrpdv_tabela.close;
                          qrpdv_tabela.sql.clear;
                          qrpdv_tabela.sql.add('select codigo from cliente where codigo = ' + inttostr(strtoint(qrservidor_tabela.fieldbyname('codigo').asstring)));
                          qrpdv_tabela.Open;

                          if qrPDV_Tabela.RecordCount > 0 then
                          begin
                            try
                              qrpdv.close;
                              qrpdv.sql.clear;
                              qrpdv.sql.add('update CLIENTE set');

                              qrpdv.sql.add('CODIGO = :CODIGO,');
                              qrpdv.sql.add('NOME = :NOME,');
                              qrpdv.sql.add('CPF = :CPF,');
                              qrpdv.sql.add('ENDERECO = :ENDERECO,');
                              qrpdv.sql.add('COMPLEMENTO = :COMPLEMENTO,');
                              qrpdv.sql.add('BAIRRO = :BAIRRO,');
                              qrpdv.sql.add('CIDADE = :CIDADE,');
                              qrpdv.sql.add('UF = :UF,');
                              qrpdv.sql.add('CEP = :CEP,');
                              qrpdv.sql.add('SITUACAO = :SITUACAO,');
                              qrpdv.sql.add('OBS = :OBS,');
                              qrpdv.sql.add('LIMITE = :LIMITE,');
                              qrpdv.sql.add('UTILIZADO = :UTILIZADO,');
                              qrpdv.sql.add('DISPONIVEL = :DISPONIVEL,');
                              qrpdv.sql.add('ATUALIZADO = :ATUALIZADO');
                              qrpdv.sql.add('where codigo = :codigo');

                              qrpdv.parambyname('CODIGO').asstring := qrservidor_tabela.fieldbyname('codigo').asstring;
                              qrpdv.parambyname('NOME').asstring := qrservidor_tabela.fieldbyname('nome').asstring;
                              qrpdv.parambyname('CPF').asstring := qrservidor_tabela.fieldbyname('cpf').asstring;
                              qrpdv.parambyname('ENDERECO').asstring := qrservidor_tabela.fieldbyname('endereco').asstring;
                              qrpdv.parambyname('COMPLEMENTO').asstring := qrservidor_tabela.fieldbyname('complemento').asstring;
                              qrpdv.parambyname('BAIRRO').asstring := qrservidor_tabela.fieldbyname('bairro').asstring;
                              qrpdv.parambyname('CIDADE').asstring := qrservidor_tabela.fieldbyname('cidade').asstring;
                              qrpdv.parambyname('UF').asstring := qrservidor_tabela.fieldbyname('uf').asstring;
                              qrpdv.parambyname('CEP').asstring := qrservidor_tabela.fieldbyname('cep').asstring;
                              if trim(qrservidor_tabela.fieldbyname('situacao').asstring) = '' then
                                qrpdv.parambyname('SITUACAO').asstring := '1'
                              else
                                qrpdv.parambyname('SITUACAO').asstring := qrservidor_tabela.fieldbyname('situacao').asstring;
                              qrpdv.parambyname('OBS').asstring :=
                                qrservidor_tabela.fieldbyname('obs1').asstring + #13 +
                                qrservidor_tabela.fieldbyname('obs2').asstring + #13 +
                                qrservidor_tabela.fieldbyname('obs3').asstring + #13 +
                                qrservidor_tabela.fieldbyname('obs4').asstring + #13 +
                                qrservidor_tabela.fieldbyname('obs5').asstring + #13 +
                                qrservidor_tabela.fieldbyname('obs6').asstring;
                              qrpdv.parambyname('LIMITE').asFLOAT := qrservidor_tabela.fieldbyname('LIMITE').AsFloat;
                              qrpdv.parambyname('UTILIZADO').asfloat := verifica_crediario(qrservidor_tabela.fieldbyname('codigo').asstring);
                              qrpdv.parambyname('DISPONIVEL').asfloat := qrpdv.parambyname('LIMITE').asFLOAT - qrpdv.parambyname('UTILIZADO').asfloat;
                              qrpdv.parambyname('ATUALIZADO').asstring := datetostr(date) + ' AS ' + TimeToStr(TIME);
                              qrpdv.ExecSQL;
                            except
                               bflag := FALSE;
                            end;
                          end
                          else
                          begin
                            try
                              if qrservidor_tabela.RecordCount > 0 then
                              begin
                                qrpdv.close;
                                qrpdv.sql.clear;
                                qrpdv.sql.add('insert into CLIENTE (');
                                qrpdv.sql.add('CODIGO,');
                                qrpdv.sql.add('NOME,');
                                qrpdv.sql.add('CPF,');
                                qrpdv.sql.add('ENDERECO,');
                                qrpdv.sql.add('COMPLEMENTO,');
                                qrpdv.sql.add('BAIRRO,');
                                qrpdv.sql.add('CIDADE,');
                                qrpdv.sql.add('UF,');
                                qrpdv.sql.add('CEP,');
                                qrpdv.sql.add('SITUACAO,');
                                qrpdv.sql.add('OBS,');
                                qrpdv.sql.add('LIMITE,');
                                qrpdv.sql.add('UTILIZADO,');
                                qrpdv.sql.add('DISPONIVEL,');
                                qrpdv.sql.add('ATUALIZADO');
                                qrpdv.sql.add(') values (');
                                qrpdv.sql.add(':CODIGO,');
                                qrpdv.sql.add(':NOME,');
                                qrpdv.sql.add(':CPF,');
                                qrpdv.sql.add(':ENDERECO,');
                                qrpdv.sql.add(':COMPLEMENTO,');
                                qrpdv.sql.add(':BAIRRO,');
                                qrpdv.sql.add(':CIDADE,');
                                qrpdv.sql.add(':UF,');
                                qrpdv.sql.add(':CEP,');
                                qrpdv.sql.add(':SITUACAO,');
                                qrpdv.sql.add(':OBS,');
                                qrpdv.sql.add(':LIMITE,');
                                qrpdv.sql.add(':UTILIZADO,');
                                qrpdv.sql.add(':DISPONIVEL,');
                                qrpdv.sql.add(':ATUALIZADO');
                                qrpdv.sql.add(')');
                                qrpdv.parambyname('CODIGO').asstring := qrservidor_tabela.fieldbyname('codigo').asstring;
                                qrpdv.parambyname('NOME').asstring := qrservidor_tabela.fieldbyname('nome').asstring;
                                qrpdv.parambyname('CPF').asstring := qrservidor_tabela.fieldbyname('cpf').asstring;
                                qrpdv.parambyname('ENDERECO').asstring := qrservidor_tabela.fieldbyname('endereco').asstring;
                                qrpdv.parambyname('COMPLEMENTO').asstring := qrservidor_tabela.fieldbyname('complemento').asstring;
                                qrpdv.parambyname('BAIRRO').asstring := qrservidor_tabela.fieldbyname('bairro').asstring;
                                qrpdv.parambyname('CIDADE').asstring := qrservidor_tabela.fieldbyname('cidade').asstring;
                                qrpdv.parambyname('UF').asstring := qrservidor_tabela.fieldbyname('uf').asstring;
                                qrpdv.parambyname('CEP').asstring := qrservidor_tabela.fieldbyname('cep').asstring;
                                qrpdv.parambyname('SITUACAO').asstring := qrservidor_tabela.fieldbyname('situacao').asstring;
                                qrpdv.parambyname('OBS').asstring :=
                                  qrservidor_tabela.fieldbyname('obs1').asstring + #13 +
                                  qrservidor_tabela.fieldbyname('obs2').asstring + #13 +
                                  qrservidor_tabela.fieldbyname('obs3').asstring + #13 +
                                  qrservidor_tabela.fieldbyname('obs4').asstring + #13 +
                                  qrservidor_tabela.fieldbyname('obs5').asstring + #13 +
                                  qrservidor_tabela.fieldbyname('obs6').asstring;
                                qrpdv.parambyname('LIMITE').asFLOAT := qrservidor_tabela.fieldbyname('LIMITE').AsFloat;
                                qrpdv.parambyname('UTILIZADO').asfloat := verifica_crediario(qrservidor_tabela.fieldbyname('codigo').asstring);
                                qrpdv.parambyname('DISPONIVEL').asfloat := qrpdv.parambyname('LIMITE').asFLOAT - qrpdv.parambyname('UTILIZADO').asfloat;
                                qrpdv.parambyname('ATUALIZADO').asstring := datetostr(date) + ' AS ' + TimeToStr(TIME);
                                qrpdv.ExecSQL;
                              end;
                            except
                              on e: exception do
                              begin
                                qrPDV.close;
                                qrpdv.sql.clear;
                                qrPDV.sql.Add('select codigo from CLIENTE');
                                qrpdv.sql.Add('where codigo = ' + inttostr(StrToInt(qrservidor.fieldbyname('codregistro').asstring)));
                                qrPDV.Open;
                                if qrpdv.RecordCount = 0 then bflag := false;
                              end;
                            end;
                          end;
                        end;

                      end;
                    3: {exclusao}
                      begin
                        try
                          memo1.lines.add('PDV' + grid.CELL[0, I].ASSTRING + ' - EXC - CLIENTE - ' + qrservidor.fieldbyname('codregistro').asstring);
                          qrpdv.close;
                          qrpdv.sql.clear;
                          qrpdv.sql.add('delete from cliente where codigo = :codigo');
                          qrpdv.parambyname('CODIGO').asinteger := strtoint(qrservidor.fieldbyname('codregistro').asstring);
                          qrpdv.ExecSQL;
                        except
                          on E: Exception do
                          begin
                            memo1.lines.add('PDV' + grid.CELL[0, I].ASSTRING + ' ERRO - EXC - CLIENTE - ' + qrservidor.fieldbyname('codregistro').asstring);
                            bflag := FALSE;

                            if POS('FOREIGN', AnsiUpperCase(E.Message)) > 0 then
                              memo1.lines.add('*** Cliente acima não pode ser apagado, pois existe cupom em seu nome!');

                          end;
                        end;
                      end;
                  end;

                end;
              except
                on E: EXCEPTION do memo1.lines.add('PDV' + grid.CELL[0, I].ASSTRING + ' - ERRO: ' + E.MESSAGE);
              end;

              qrservidor.close;


  finally

  end;
end;

end.
